<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix PDI Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        .navbar { background: white; border-bottom: 4px solid #003366; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .logo-img { height: 50px; object-fit: contain; }
        
        .card { border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; background: #fff; }
        .card-header { font-weight: 700; color: #003366; background: #fff; border-bottom: 2px solid #eee; padding: 15px; }
        .form-label { font-size: 13px; font-weight: 600; color: #555; }
        .form-control, .form-select { font-size: 14px; border: 1px solid #dcdcdc; border-radius: 4px; }
        .form-control:focus { border-color: #003366; box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1); }
        
        /* --- EXACT PREVIEW STYLES (MATCHING SCREENSHOT) --- */
        .report-paper { background: white; padding: 40px; border: 1px solid #ddd; width: 100%; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        .report-header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 3px solid #003366; padding-bottom: 10px; margin-bottom: 20px; }
        .report-title { color: #003366; font-size: 24px; font-weight: 900; text-transform: uppercase; margin: 0; }
        .report-meta { font-size: 12px; color: #666; text-align: right; }

        /* Info Strip */
        .info-strip { display: flex; justify-content: space-between; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .info-item small { display: block; font-size: 10px; text-transform: uppercase; color: #777; font-weight: bold; letter-spacing: 0.5px; }
        .info-item strong { display: block; font-size: 14px; color: #000; }

        /* Section Headers */
        .sec-head { 
            background: #f1f5f9; 
            color: #003366; 
            padding: 8px 12px; 
            font-weight: 700; 
            margin-bottom: 10px; 
            border-left: 5px solid #003366; /* The Blue Bar */
            font-size: 14px;
        }

        /* Tables */
        .preview-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 13px; }
        .preview-table td { padding: 8px 5px; border-bottom: 1px solid #eee; vertical-align: top; }
        .lbl { font-weight: 600; color: #444; width: 40%; }
        .val { color: #000; }

        /* CAPA Box (Red Dashed) */
        .capa-box { 
            border: 1px dashed #dc3545; 
            background-color: #fef2f2; /* Very light red */
            padding: 15px; 
            border-radius: 4px; 
            margin-top: 10px;
            font-size: 13px;
            color: #333;
        }
        .capa-row { margin-bottom: 8px; }
        .capa-lbl { font-weight: bold; color: #b02a37; margin-right: 5px; }
    </style>
</head>
<body>

<nav class="navbar fixed-top">
    <div class="container-fluid px-5">
        <div class="d-flex align-items-center gap-3">
            <img src="https://i.postimg.cc/5y7SN4xc/logo.png" id="navLogo" class="logo-img" alt="CALIFONIX">
            <h4 style="color:#003366; font-weight:bold; margin:0;">PDI TRACKER</h4>
        </div>
        <div class="nav nav-pills">
            <button class="nav-link active rounded-pill px-4" id="tab-form" data-bs-toggle="pill" data-bs-target="#pills-form">New Entry</button>
            <button class="nav-link rounded-pill px-4" id="tab-dash" data-bs-toggle="pill" data-bs-target="#pills-dash" onclick="loadDashboard()">Live Dashboard</button>
        </div>
    </div>
</nav>

<div class="container" style="margin-top: 100px; padding-bottom: 50px;">
    <div class="tab-content">
        <!-- FORM TAB -->
        <div class="tab-pane fade show active" id="pills-form">
            <form id="pdiForm">
                <input type="hidden" name="action" id="formAction" value="save">
                <input type="hidden" name="editRowId" id="editRowId">

                <div class="row">
                    <!-- Left Column -->
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-info-circle-fill me-2"></i>Product Info</div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-3"><label class="form-label">Date</label><input type="date" name="Date" class="form-control" required></div>
                                    <div class="col-md-3"><label class="form-label">Model</label><input type="text" name="Model" class="form-control" required></div>
                                    <div class="col-md-3"><label class="form-label">Line No</label><input type="text" name="Line No" class="form-control" required></div>
                                    <div class="col-md-3"><label class="form-label">Colour</label><input type="text" name="Colour" class="form-control"></div>
                                    <div class="col-md-3"><label class="form-label">Lot Qty</label><input type="number" name="Lot Qty" class="form-control"></div>
                                    <div class="col-md-3"><label class="form-label">Sample Qty</label><input type="number" name="Sample Qty" id="sampleQty" class="form-control" oninput="calc()"></div>
                                    <div class="col-md-3"><label class="form-label text-danger">Defects</label><input type="number" name="Total Defect" id="totalDefect" class="form-control fw-bold" readonly></div>
                                    <div class="col-md-3"><label class="form-label text-danger">SRR %</label><input type="text" name="SRR" id="srrRate" class="form-control fw-bold" readonly></div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Defect Details</div>
                            <div class="card-body">
                                <div class="row g-2 mb-2 align-items-center">
                                    <div class="col-md-2 fw-bold">Functional</div>
                                    <div class="col-md-8"><input type="text" name="Func Details" id="fDet" class="form-control" placeholder="Description..."></div>
                                    <div class="col-md-2"><input type="number" name="Func Qty" id="fQty" class="form-control" placeholder="Qty" oninput="calc()"></div>
                                </div>
                                <div class="row g-2 mb-2 align-items-center">
                                    <div class="col-md-2 fw-bold">Aesthetic</div>
                                    <div class="col-md-8"><input type="text" name="Aes Details" id="aDet" class="form-control" placeholder="Description..."></div>
                                    <div class="col-md-2"><input type="number" name="Aes Qty" id="aQty" class="form-control" placeholder="Qty" oninput="calc()"></div>
                                </div>
                                <div class="row g-2 align-items-center">
                                    <div class="col-md-2 fw-bold">Packing</div>
                                    <div class="col-md-8"><input type="text" name="Pack Details" id="pDet" class="form-control" placeholder="Description..."></div>
                                    <div class="col-md-2"><input type="number" name="Pack Qty" id="pQty" class="form-control" placeholder="Qty" oninput="calc()"></div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white"><i class="bi bi-shield-check me-2"></i>CAPA (Action Plan)</div>
                            <div class="card-body">
                                <label class="form-label">Problem Statement (Auto)</label>
                                <input type="text" name="Problem" id="problemDesc" class="form-control mb-2 bg-light fw-bold" readonly>
                                <div class="row g-2">
                                    <div class="col-md-6"><label class="form-label">Root Cause</label><textarea name="Root Cause" class="form-control" rows="2"></textarea></div>
                                    <div class="col-md-6"><label class="form-label">Corrective Action</label><textarea name="Corrective" class="form-control" rows="2"></textarea></div>
                                    <div class="col-md-12"><label class="form-label">Preventive Action</label><textarea name="Preventive" class="form-control" rows="2"></textarea></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header text-success"><i class="bi bi-qr-code me-2"></i>Traceability</div>
                            <div class="card-body">
                                <div class="mb-2"><label class="form-label">Master Carton Date</label><input type="datetime-local" name="MC Date" class="form-control"></div>
                                <div class="mb-2"><label class="form-label">Defect Origin</label><select name="Belongs To" class="form-select"><option value="">Select</option><option>Buds</option><option>Case</option></select></div>
                                
                                <div class="row g-2 mb-2">
                                    <div class="col-6"><label class="form-label">BT Attempt</label><select name="BT Attempt" class="form-select"><option value="">Select</option><option>Yes</option><option>No</option></select></div>
                                    <div class="col-6"><label class="form-label">RF Attempt</label><select name="RF Attempt" class="form-select"><option value="">Select</option><option>Yes</option><option>No</option></select></div>
                                </div>

                                <div class="bg-light p-2 border rounded mb-2">
                                    <small class="fw-bold text-primary">LQC Check</small>
                                    <input type="datetime-local" name="LQC Date" class="form-control form-control-sm mb-1">
                                    <input type="text" name="LQC Name" class="form-control form-control-sm" placeholder="Operator Name">
                                </div>
                                <div class="bg-light p-2 border rounded">
                                    <small class="fw-bold text-primary">FT Check</small>
                                    <input type="datetime-local" name="FT Date" class="form-control form-control-sm mb-1">
                                    <input type="text" name="FT Name" class="form-control form-control-sm" placeholder="Operator Name">
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header"><i class="bi bi-image me-2"></i>Evidence</div>
                            <div class="card-body text-center">
                                <input type="file" id="evidenceInput" class="form-control mb-2" accept="image/*" onchange="handleEvidence()">
                                <div id="evidencePreviewBox" style="min-height:100px; background:#f9f9f9; display:flex; align-items:center; justify-content:center; border:1px dashed #ccc;">
                                    <small class="text-muted">No Image Selected</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-3 my-4">
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">Clear</button>
                    <button type="button" class="btn btn-dark" onclick="showFullPreview()">ðŸ“„ Generate Preview</button>
                    <button type="submit" class="btn btn-primary px-5" id="saveBtn">ðŸ’¾ Save Record</button>
                </div>
            </form>
        </div>

        <!-- DASHBOARD TAB -->
        <div class="tab-pane fade" id="pills-dash">
            <div class="card p-3">
                <div class="row g-2 mb-3">
                    <div class="col-md-3"><label>Start Date</label><input type="date" id="filterStart" class="form-control"></div>
                    <div class="col-md-3"><label>End Date</label><input type="date" id="filterEnd" class="form-control"></div>
                    <div class="col-md-3 d-flex align-items-end"><button class="btn btn-primary w-100" onclick="loadDashboard()">Apply Filter</button></div>
                    <div class="col-md-3 d-flex align-items-end"><button class="btn btn-outline-dark w-100" onclick="loadDashboard()">Show All</button></div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover text-center align-middle">
                        <thead class="table-dark">
                            <tr><th>Date</th><th>Model</th><th>Line</th><th>Total Defect</th><th>Problem</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="dashData"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PROFESSIONAL PREVIEW MODAL -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-body" style="background:#525659; padding:30px;">
                <div id="previewContent" class="report-paper mx-auto">
                    <!-- Dynamic Content Loads Here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button class="btn btn-danger" onclick="downloadPPT()">â¬‡ Download PPT</button>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz6voWBrmtTiETIB9JkTG_gas3amEHRN6xOIi-Qkxj1E4CFOsvvSLLgw0FShqqiIuVB/exec';
    const LOGO_URL = "https://i.postimg.cc/5y7SN4xc/logo.png";
    
    let evidenceImg = null;
    let logoBase64 = null;

    window.onload = function() {
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.src = LOGO_URL;
        img.onload = function(){
            const canvas = document.createElement('canvas');
            canvas.width = img.width; canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            logoBase64 = canvas.toDataURL("image/png");
        };
    };

    function handleEvidence() {
        const file = document.getElementById('evidenceInput').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => {
                evidenceImg = e.target.result;
                document.getElementById('evidencePreviewBox').innerHTML = `<img src="${evidenceImg}" style="max-height:150px; max-width:100%; border-radius:4px;">`;
            };
            reader.readAsDataURL(file);
        }
    }

    function calc() {
        const f = Number(document.getElementById('fQty').value)||0;
        const a = Number(document.getElementById('aQty').value)||0;
        const p = Number(document.getElementById('pQty').value)||0;
        const s = Number(document.getElementById('sampleQty').value)||0;
        const t = f+a+p;
        document.getElementById('totalDefect').value = t;
        document.getElementById('srrRate').value = s>0 ? ((t/s)*100).toFixed(2)+'%' : '0%';
        let prob = "No Major Issues";
        if(f>0) prob = `Func: ${document.getElementById('fDet').value} (${f})`;
        else if(a>0) prob = `Aes: ${document.getElementById('aDet').value} (${a})`;
        else if(p>0) prob = `Pack: ${document.getElementById('pDet').value} (${p})`;
        document.getElementById('problemDesc').value = prob;
    }

    document.getElementById('pdiForm').addEventListener('submit', e => {
        e.preventDefault();
        const btn = document.getElementById('saveBtn');
        btn.innerText = 'Saving...'; btn.disabled = true;
        fetch(SCRIPT_URL, {method:'POST', body:new FormData(e.target)})
        .then(res=>res.json())
        .then(d=>{ alert(d.message); resetForm(); btn.innerText='Save Record'; btn.disabled=false; })
        .catch(()=>{ alert("Error"); btn.disabled=false; });
    });

    function resetForm() {
        document.getElementById('pdiForm').reset();
        document.getElementById('formAction').value = 'save';
        document.getElementById('editRowId').value = '';
        document.getElementById('evidencePreviewBox').innerHTML = '<small class="text-muted">No Image</small>';
        evidenceImg = null;
    }

    function loadDashboard() {
        const tbody = document.getElementById('dashData');
        tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
        const start = document.getElementById('filterStart').value;
        const end = document.getElementById('filterEnd').value;
        fetch(SCRIPT_URL).then(r=>r.json()).then(json => {
            tbody.innerHTML = '';
            const rows = json.data.filter(r => (!start || r[1] >= start) && (!end || r[1] <= end));
            if(rows.length===0) tbody.innerHTML = '<tr><td colspan="6">No Data</td></tr>';
            rows.forEach(r => {
                let rowStr = encodeURIComponent(JSON.stringify(r));
                tbody.innerHTML += `
                    <tr>
                        <td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td>
                        <td class="text-danger fw-bold">${r[7]}</td><td class="small text-start">${r[24]}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editRec('${rowStr}')"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="delRec('${r[0]}')"><i class="bi bi-trash"></i></button>
                            <button class="btn btn-sm btn-success" onclick="pptRec('${rowStr}')">PPT</button>
                        </td>
                    </tr>`;
            });
        });
    }

    function editRec(str) {
        const r = JSON.parse(decodeURIComponent(str));
        document.getElementById('tab-form').click();
        const f = document.getElementById('pdiForm').elements;
        document.getElementById('formAction').value = 'edit';
        document.getElementById('editRowId').value = r[0];
        f['Date'].value=r[1]; f['Model'].value=r[2]; f['Line No'].value=r[3];
        f['Colour'].value=r[4]; f['Lot Qty'].value=r[5]; f['Sample Qty'].value=r[6];
        f['Total Defect'].value=r[7]; f['SRR'].value=r[8];
        f['Func Details'].value=r[9]; f['Func Qty'].value=r[10];
        f['Aes Details'].value=r[11]; f['Aes Qty'].value=r[12];
        f['Pack Details'].value=r[13]; f['Pack Qty'].value=r[14];
        f['MC Date'].value=r[15]; f['LQC Date'].value=r[16]; f['LQC Name'].value=r[17];
        f['FT Date'].value=r[18]; f['FT Name'].value=r[19];
        f['Belongs To'].value=r[20]; f['BT Attempt'].value=r[21]; f['RF Attempt'].value=r[22];
        f['Team'].value=r[23]; f['Problem'].value=r[24]; f['Root Cause'].value=r[25];
        f['Corrective'].value=r[26]; f['Preventive'].value=r[27];
    }

    async function delRec(id) {
        if(confirm("Delete record?")) {
            const fd = new FormData(); fd.append('action','delete'); fd.append('rowIndex', id);
            await fetch(SCRIPT_URL,{method:'POST',body:fd});
            loadDashboard();
        }
    }

    // --- EXACT SCREENSHOT PREVIEW ---
    function genRow(label, value, isBold=false) {
        if(!value || value === "0") return "";
        return `<tr><td class="lbl">${label}</td><td class="val" ${isBold ? 'style="font-weight:bold;"' : ''}>${value}</td></tr>`;
    }

    function showFullPreview() {
        const fd = new FormData(document.getElementById('pdiForm'));
        const d = (k) => fd.get(k);

        // Build Data
        let prodRows = "";
        prodRows += genRow("Lot Qty", d('Lot Qty'));
        prodRows += genRow("Sample Qty", d('Sample Qty'));
        prodRows += genRow("Total Defects", d('Total Defect'), true);
        prodRows += genRow("SRR %", d('SRR'), true);
        
        let defectRows = "";
        if(Number(d('Func Qty')) > 0) defectRows += genRow("Functional", `${d('Func Details')} (${d('Func Qty')})`);
        if(Number(d('Aes Qty')) > 0) defectRows += genRow("Aesthetic", `${d('Aes Details')} (${d('Aes Qty')})`);
        if(Number(d('Pack Qty')) > 0) defectRows += genRow("Packing", `${d('Pack Details')} (${d('Pack Qty')})`);

        let traceRows = "";
        if(d('MC Date')) traceRows += genRow("MC Date", d('MC Date'));
        if(d('Belongs To')) traceRows += genRow("Origin", d('Belongs To'));
        if(d('FT Name')) traceRows += genRow("FT Info", `${d('FT Date')} (${d('FT Name')})`);
        if(d('BT Attempt') || d('RF Attempt')) traceRows += genRow("Attempts", `BT: ${d('BT Attempt')} / RF: ${d('RF Attempt')}`);

        let capaHtml = "";
        if(d('Problem')) capaHtml += `<div class="capa-row"><span class="capa-lbl">Problem:</span>${d('Problem')}</div>`;
        if(d('Root Cause')) capaHtml += `<div class="capa-row"><span class="capa-lbl">Root Cause:</span>${d('Root Cause')}</div>`;
        if(d('Corrective')) capaHtml += `<div class="capa-row"><span class="capa-lbl">Corrective:</span>${d('Corrective')}</div>`;
        if(d('Preventive')) capaHtml += `<div class="capa-row"><span class="capa-lbl">Preventive:</span>${d('Preventive')}</div>`;

        const html = `
            <div class="report-header">
                <img src="${LOGO_URL}" style="height:50px;">
                <div class="text-end">
                    <h2 class="report-title">PDI Inspection Report</h2>
                    <div class="report-meta">Generated: ${new Date().toLocaleDateString()}</div>
                </div>
            </div>

            <div class="info-strip">
                <div class="info-item"><small>MODEL</small><strong>${d('Model')}</strong></div>
                <div class="info-item"><small>DATE</small><strong>${d('Date')}</strong></div>
                <div class="info-item"><small>LINE</small><strong>${d('Line No')}</strong></div>
                <div class="info-item"><small>COLOR</small><strong>${d('Colour') || '-'}</strong></div>
            </div>

            <div class="row">
                <div class="col-6">
                    <div class="sec-head">Production & Defects</div>
                    <table class="preview-table">${prodRows}</table>
                    ${defectRows ? `<div style="border-top:1px dashed #ccc; margin:10px 0;"></div><table class="preview-table">${defectRows}</table>` : ''}
                </div>
                <div class="col-6" style="border-left:1px solid #f0f0f0;">
                    <div class="sec-head">Traceability</div>
                    <table class="preview-table">${traceRows || '<tr><td colspan="2" class="text-muted">No Data</td></tr>'}</table>
                </div>
            </div>

            <div style="margin-top:20px;">
                <div class="sec-head">CAPA (Action Plan)</div>
                <div class="capa-box">
                    ${capaHtml || '<span class="text-muted">No Action Plan Recorded</span>'}
                </div>
            </div>

            <div class="text-center mt-3">
                ${evidenceImg ? `<img src="${evidenceImg}" style="max-height:200px; border:1px solid #ddd; padding:5px;">` : ''}
            </div>
        `;
        document.getElementById('previewContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('previewModal')).show();
    }

    function downloadPPT() {
        const fd = new FormData(document.getElementById('pdiForm'));
        const d = {}; fd.forEach((v,k)=>d[k]=v);
        generatePPT(d, evidenceImg);
    }

    function pptRec(str) {
        const r = JSON.parse(decodeURIComponent(str));
        const d = {
            'Date':r[1], 'Model':r[2], 'Line No':r[3], 'Colour':r[4], 'Lot Qty':r[5], 'Sample Qty':r[6],
            'Total Defect':r[7], 'SRR':r[8], 'Func Details':r[9], 'Func Qty':r[10], 'Aes Details':r[11], 'Aes Qty':r[12], 'Pack Details':r[13], 'Pack Qty':r[14],
            'MC Date':r[15], 'LQC Date':r[16], 'LQC Name':r[17], 'FT Date':r[18], 'FT Name':r[19], 'Belongs To':r[20], 'BT Attempt':r[21], 'RF Attempt':r[22],
            'Problem':r[24], 'Root Cause':r[25], 'Corrective':r[26], 'Preventive':r[27]
        };
        generatePPT(d, null);
    }

    // --- REPLICATE EXACT PREVIEW IN PPT ---
    function generatePPT(data, img) {
        let pres = new PptxGenJS();
        let slide = pres.addSlide();
        
        // 1. Header (Replicating the White look with Blue Text)
        if(logoBase64) slide.addImage({ data: logoBase64, x: 0.3, y: 0.2, w: 1.5, h: 0.5 });
        slide.addText("PDI INSPECTION REPORT", { x: 5.5, y: 0.3, w: 4.2, align:'right', fontSize: 18, bold: true, color: '003366', fontFace:'Arial' });
        slide.addText(`Generated: ${new Date().toLocaleDateString()}`, { x: 5.5, y: 0.6, w: 4.2, align:'right', fontSize: 9, color: '666666' });
        slide.addShape(pres.ShapeType.line, { x: 0.3, y: 0.8, w: 9.4, h: 0, line: { color: '003366', width: 3 } });

        // 2. Info Strip (Light Gray Headers, Bold Values)
        let yInfo = 1.0;
        const infoOpts = { fontSize: 8, color: '666666', bold: true };
        const valOpts = { fontSize: 11, color: '000000', bold: true };
        
        // Using Table for Alignment
        slide.addTable([
            [
                {text:"MODEL", options:infoOpts}, {text:"DATE", options:infoOpts}, 
                {text:"LINE", options:infoOpts}, {text:"COLOR", options:infoOpts}
            ],
            [
                {text:data['Model'], options:valOpts}, {text:data['Date'], options:valOpts}, 
                {text:data['Line No'], options:valOpts}, {text:data['Colour']||'-', options:valOpts}
            ]
        ], {
            x: 0.3, y: yInfo, w: 9.4, 
            rowH: [0.2, 0.3], 
            colW: [2.35, 2.35, 2.35, 2.35],
            border: { b: { pt: 1, color: "EEEEEE" } }, // Bottom border only
            fill: { color: "FFFFFF" }
        });

        // 3. Two-Column Layout
        let yCols = 1.8;
        
        // --- Left Column: Production & Defects ---
        // Header
        slide.addShape(pres.ShapeType.rect, { x:0.3, y:yCols, w:0.05, h:0.3, fill:'003366' }); // Blue bar
        slide.addText("Production & Defects", { x:0.4, y:yCols, w:4.0, h:0.3, rect:{fill:'F1F5F9'}, fontSize:11, bold:true, color:'003366', valign:'middle' });
        
        let leftRows = [];
        if(data['Lot Qty']) leftRows.push(['Lot Qty', data['Lot Qty']]);
        if(data['Sample Qty']) leftRows.push(['Sample Qty', data['Sample Qty']]);
        if(data['Total Defect']) leftRows.push(['Total Defects', data['Total Defect']]);
        if(data['SRR'] || data['SRR %']) leftRows.push(['SRR %', data['SRR'] || data['SRR %']]);
        
        // Add Divider logic by inserting empty row? No, create separate table if needed.
        // Let's add defects to same list with indent/style difference
        if(Number(data['Func Qty'])>0) leftRows.push([{text:'Functional', options:{color:'003366'}}, `${data['Func Details']} (${data['Func Qty']})`]);
        if(Number(data['Aes Qty'])>0) leftRows.push([{text:'Aesthetic', options:{color:'003366'}}, `${data['Aes Details']} (${data['Aes Qty']})`]);
        if(Number(data['Pack Qty'])>0) leftRows.push([{text:'Packing', options:{color:'003366'}}, `${data['Pack Details']} (${data['Pack Qty']})`]);

        if(leftRows.length > 0) {
            slide.addTable(leftRows, {
                x: 0.3, y: yCols + 0.4, w: 4.4,
                fontSize: 10, rowH: 0.3,
                border: { b: { pt: 0.5, color: "EEEEEE" } },
                colW: [1.2, 3.2]
            });
        }

        // --- Right Column: Traceability ---
        // Header
        slide.addShape(pres.ShapeType.rect, { x:5.0, y:yCols, w:0.05, h:0.3, fill:'003366' }); // Blue bar
        slide.addText("Traceability", { x:5.1, y:yCols, w:4.0, h:0.3, rect:{fill:'F1F5F9'}, fontSize:11, bold:true, color:'003366', valign:'middle' });

        let rightRows = [];
        if(data['MC Date']) rightRows.push(['MC Date', data['MC Date']]);
        if(data['Belongs To']) rightRows.push(['Origin', data['Belongs To']]);
        if(data['FT Name']) rightRows.push(['FT Info', `${data['FT Date'] || ''} (${data['FT Name']})`]);
        if(data['BT Attempt']) rightRows.push(['Attempts', `BT: ${data['BT Attempt']} / RF: ${data['RF Attempt']}`]);

        if(rightRows.length > 0) {
            slide.addTable(rightRows, {
                x: 5.0, y: yCols + 0.4, w: 4.4,
                fontSize: 10, rowH: 0.3,
                border: { b: { pt: 0.5, color: "EEEEEE" } },
                colW: [1.0, 3.4]
            });
        }

        // 4. CAPA Section (Dynamic Position)
        // Calculate approx height used by top section to place CAPA below it
        let maxRows = Math.max(leftRows.length, rightRows.length);
        let capaY = yCols + 0.4 + (maxRows * 0.3) + 0.3; // Dynamic Y start

        // Header
        slide.addShape(pres.ShapeType.rect, { x:0.3, y:capaY, w:0.05, h:0.3, fill:'003366' });
        slide.addText("CAPA (Action Plan)", { x:0.4, y:capaY, w:9.3, h:0.3, rect:{fill:'F1F5F9'}, fontSize:11, bold:true, color:'003366', valign:'middle' });

        // The Red Dashed Box Content
        let capaText = [];
        if(data['Problem']) capaText.push({ text: "Problem: ", options: { bold: true, color:'B02A37', breakLine:false } });
        if(data['Problem']) capaText.push({ text: data['Problem'] + "\n", options: { breakLine:true } });
        
        if(data['Root Cause']) capaText.push({ text: "Root Cause: ", options: { bold: true, color:'B02A37', breakLine:false } });
        if(data['Root Cause']) capaText.push({ text: data['Root Cause'] + "\n", options: { breakLine:true } });

        if(data['Corrective']) capaText.push({ text: "Corrective: ", options: { bold: true, color:'B02A37', breakLine:false } });
        if(data['Corrective']) capaText.push({ text: data['Corrective'] + "\n", options: { breakLine:true } });

        if(data['Preventive']) capaText.push({ text: "Preventive: ", options: { bold: true, color:'B02A37', breakLine:false } });
        if(data['Preventive']) capaText.push({ text: data['Preventive'], options: { breakLine:true } });

        if(capaText.length > 0) {
            slide.addText(capaText, {
                x: 0.3, y: capaY + 0.4, w: 9.4,
                fontSize: 10, color: '333333',
                rect: { fill: 'FEF2F2' }, // Light red fill
                line: { color: 'DC3545', width: 1, style: 'dash' }, // Red dashed border
                inset: 0.1
            });
        }

        // 5. Image (If space exists, place bottom right, else separate slide logic or small overlay)
        if(img) {
            slide.addImage({ data: img, x: 8.0, y: 0.9, w: 1.5, h: 1.0 }); // Header Right Corner (safest spot)
        }

        pres.writeFile({ fileName: `PDI_Report_${data['Model']}.pptx` });
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
