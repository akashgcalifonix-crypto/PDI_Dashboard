<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix PDI Dashboard</title>
    <!-- Bootstrap 5 & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50; /* Califonix Dark */
            --accent-color: #e74c3c;  /* Red Accent */
            --bg-light: #f8f9fa;
        }
        body { background-color: var(--bg-light); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Header Styling */
        .header-bar {
            background: white;
            border-bottom: 3px solid var(--accent-color);
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .logo-img { max-height: 60px; }

        /* Form Cards */
        .card { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .section-header { 
            background: linear-gradient(45deg, #2c3e50, #4ca1af); 
            color: white; 
            padding: 12px 20px; 
            border-radius: 10px 10px 0 0; 
            font-weight: 600;
        }
        .bg-danger-gradient { background: linear-gradient(45deg, #cb2d3e, #ef473a); color: white; }

        /* Preview Modal Styling */
        .dashboard-metric { text-align: center; padding: 15px; border-radius: 8px; color: white; }
        .metric-title { font-size: 0.9rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
        .metric-value { font-size: 2rem; font-weight: bold; }
        
        .defect-card { border-left: 5px solid #ccc; background: #fff; padding: 15px; margin-bottom: 10px; }
        .defect-func { border-left-color: #dc3545; }
        .defect-aes { border-left-color: #fd7e14; }
        .defect-pack { border-left-color: #ffc107; }

        .action-plan-box { background-color: #e9ecef; padding: 15px; border-radius: 5px; border-left: 4px solid var(--primary-color); }
    </style>
</head>
<body>

<!-- Header -->
<div class="header-bar">
    <div class="container d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
            <!-- Tries to load logo.png from GitHub, fallback to placeholder -->
            <img src="logo.png" id="mainLogo" class="logo-img" alt="Califonix Logo" onerror="this.style.display='none'">
            <h3 class="m-0 fw-bold text-dark">PDI Performance Dashboard</h3>
        </div>
        <div>
            <!-- Manual Upload if logo.png is missing -->
            <input type="file" id="logoUploader" class="form-control form-control-sm" accept="image/*" onchange="loadLogoManual()">
        </div>
    </div>
</div>

<div class="container">
    <form id="pdiForm" name="submit-to-google-sheet">
        
        <!-- 1. General Info -->
        <div class="card">
            <div class="section-header"><i class="bi bi-info-circle-fill me-2"></i>General Information</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label text-muted">Date</label>
                        <input type="date" name="Date" class="form-control fw-bold" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted">Model Name</label>
                        <input type="text" name="Model" class="form-control fw-bold" placeholder="e.g. Earbuds X1" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted">Colour</label>
                        <input type="text" name="Colour" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted">Lot Qty</label>
                        <input type="number" name="Lot Qty" id="lotQty" class="form-control" placeholder="0">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted">Sample Qty</label>
                        <input type="number" name="Sample Qty" id="sampleQty" class="form-control" placeholder="0">
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Defect Details -->
        <div class="card">
            <div class="section-header"><i class="bi bi-exclamation-triangle-fill me-2"></i>Defect Details</div>
            <div class="card-body">
                <!-- Function -->
                <div class="row align-items-center mb-3">
                    <div class="col-md-2"><span class="badge bg-danger p-2 w-100">Function</span></div>
                    <div class="col-md-7"><input type="text" name="Func Defect Details" id="funcDetail" class="form-control" placeholder="Describe functional issue..."></div>
                    <div class="col-md-3"><input type="number" name="Func Qty" id="funcQty" class="form-control" placeholder="Qty" oninput="calculatePriority()"></div>
                </div>
                <!-- Aesthetics -->
                <div class="row align-items-center mb-3">
                    <div class="col-md-2"><span class="badge bg-warning text-dark p-2 w-100">Aesthetics</span></div>
                    <div class="col-md-7"><input type="text" name="Aes Defect Details" id="aesDetail" class="form-control" placeholder="Describe cosmetic issue..."></div>
                    <div class="col-md-3"><input type="number" name="Aes Qty" id="aesQty" class="form-control" placeholder="Qty" oninput="calculatePriority()"></div>
                </div>
                <!-- Packing -->
                <div class="row align-items-center">
                    <div class="col-md-2"><span class="badge bg-info text-dark p-2 w-100">Packing</span></div>
                    <div class="col-md-7"><input type="text" name="Pack Defect Details" id="packDetail" class="form-control" placeholder="Describe packing issue..."></div>
                    <div class="col-md-3"><input type="number" name="Pack Qty" id="packQty" class="form-control" placeholder="Qty" oninput="calculatePriority()"></div>
                </div>
            </div>
        </div>

        <!-- 3. Process & Operators -->
        <div class="card">
            <div class="section-header"><i class="bi bi-people-fill me-2"></i>Process Traceability</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="small text-muted">Master Carton Date</label>
                        <input type="datetime-local" name="Master Carton Date" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="small text-muted">LQC Date</label>
                        <input type="datetime-local" name="LQC Date" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="small text-muted">LQC Operator</label>
                        <input type="text" name="LQC Name" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="small text-muted">FT Date</label>
                        <input type="datetime-local" name="FT Date" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="small text-muted">FT Operator</label>
                        <input type="text" name="FT Name" class="form-control">
                    </div>
                </div>
                <hr>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Defect Origin</label>
                        <select name="Defect Belongs To" class="form-select">
                            <option value="Buds">Buds</option>
                            <option value="Charging">Charging Case</option>
                            <option value="Accessories">Accessories</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">BT Attempted?</label>
                        <select name="BT Attempt" class="form-select">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">RF Attempted?</label>
                        <select name="RF Attempt" class="form-select">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. Action Plan -->
        <div class="card border-danger">
            <div class="section-header bg-danger-gradient"><i class="bi bi-lightning-charge-fill me-2"></i>Corrective Action Plan</div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="fw-bold">1. Team Formation</label>
                    <input type="text" name="Team Formation" class="form-control" placeholder="Names of team members">
                </div>
                <div class="mb-3">
                    <label class="fw-bold text-danger">2. Problem Description (Auto-Generated)</label>
                    <textarea name="Problem Desc" id="problemDesc" class="form-control bg-light" rows="2" readonly></textarea>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="fw-bold">3. Root Cause Analysis</label>
                        <textarea name="Root Cause" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="fw-bold">4. Corrective Action</label>
                        <textarea name="Corrective Action" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="fw-bold">5. Preventive Action</label>
                        <textarea name="Preventive Action" class="form-control" rows="3"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-center gap-3 mb-5">
            <button type="button" class="btn btn-lg btn-outline-dark" onclick="showDashboardPreview()"><i class="bi bi-eye"></i> Preview Dashboard</button>
            <button type="button" class="btn btn-lg btn-success" onclick="downloadExcel()"><i class="bi bi-file-earmark-excel"></i> Excel</button>
            <button type="button" class="btn btn-lg btn-danger" onclick="downloadPPT()"><i class="bi bi-file-earmark-slides"></i> PPT</button>
            <button type="submit" class="btn btn-lg btn-primary" id="submitBtn"><i class="bi bi-cloud-upload"></i> Save to Cloud</button>
        </div>
    </form>
</div>

<!-- Professional Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl"> <!-- Extra Large Modal -->
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">PDI Summary Report</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light" id="dashboardContent">
                <!-- Content injected by JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" onclick="downloadPPT()">Download Report</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Configuration ---
    // !!! PASTE YOUR GOOGLE SCRIPT URL BELOW !!!
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxUi5cHC8awxTYjZNx3Q04zY3zf5AFi33POoZVS0izMs-GmR-sy3oUeG3gysDdhM_Y/exec'; 

    let logoData = 'logo.png'; // Default to local file

    // 1. Logo Handling
    function loadLogoManual() {
        const file = document.getElementById('logoUploader').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => { 
                logoData = e.target.result; 
                document.getElementById('mainLogo').src = logoData;
                document.getElementById('mainLogo').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }

    // Try to convert default logo to base64 for PPT export
    window.onload = function() {
        // Attempt to fetch local image and convert to base64 for PPT
        fetch('logo.png')
            .then(response => response.blob())
            .then(blob => {
                const reader = new FileReader();
                reader.onloadend = () => { logoData = reader.result; };
                reader.readAsDataURL(blob);
            })
            .catch(() => console.log("No default logo.png found"));
    };

    // 2. Logic: Auto-Populate Problem
    function calculatePriority() {
        const fQty = document.getElementById('funcQty').value;
        const aQty = document.getElementById('aesQty').value;
        const pQty = document.getElementById('packQty').value;
        
        const fDet = document.getElementById('funcDetail').value;
        const aDet = document.getElementById('aesDetail').value;
        const pDet = document.getElementById('packDetail').value;

        let txt = "No Major Defects Found";
        if (fQty > 0) txt = `[MAJOR] Function: ${fDet} (Qty: ${fQty})`;
        else if (aQty > 0) txt = `[MINOR] Aesthetic: ${aDet} (Qty: ${aQty})`;
        else if (pQty > 0) txt = `[MINOR] Packing: ${pDet} (Qty: ${pQty})`;

        document.getElementById('problemDesc').value = txt;
    }

    // 3. Professional Dashboard Preview
    function showDashboardPreview() {
        const f = document.forms['submit-to-google-sheet'];
        const date = f['Date'].value;
        const model = f['Model'].value;
        const lot = f['Lot Qty'].value || 0;
        const sample = f['Sample Qty'].value || 0;
        
        // Defect Data
        const fQ = f['Func Qty'].value || 0;
        const aQ = f['Aes Qty'].value || 0;
        const pQ = f['Pack Qty'].value || 0;
        const totalDefect = parseInt(fQ) + parseInt(aQ) + parseInt(pQ);
        
        // Calculate DPPM (Simplified)
        let dppm = sample > 0 ? ((totalDefect / sample) * 1000000).toFixed(0) : 0;

        let html = `
            <div class="container-fluid p-3">
                <!-- Header Section -->
                <div class="row align-items-center mb-4 border-bottom pb-2">
                    <div class="col-md-2"><img src="${logoData}" style="max-height: 50px;"></div>
                    <div class="col-md-6 text-center"><h2>${model} PDI Scorecard</h2></div>
                    <div class="col-md-4 text-end text-muted">Date: ${date}</div>
                </div>

                <!-- Metrics Row -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="dashboard-metric bg-primary">
                            <div class="metric-title">Lot Qty</div>
                            <div class="metric-value">${lot}</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="dashboard-metric bg-success">
                            <div class="metric-title">Sample Qty</div>
                            <div class="metric-value">${sample}</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="dashboard-metric bg-danger">
                            <div class="metric-title">Total Defects</div>
                            <div class="metric-value">${totalDefect}</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="dashboard-metric bg-dark">
                            <div class="metric-title">DPPM</div>
                            <div class="metric-value">${dppm}</div>
                        </div>
                    </div>
                </div>

                <!-- Defect Breakdown -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="border-bottom pb-2">Defect Breakdown</h5>
                        ${fQ > 0 ? `<div class="defect-card defect-func"><strong>Function:</strong> ${f['Func Defect Details'].value} <span class="float-end badge bg-danger">${fQ}</span></div>` : ''}
                        ${aQ > 0 ? `<div class="defect-card defect-aes"><strong>Aesthetics:</strong> ${f['Aes Defect Details'].value} <span class="float-end badge bg-warning text-dark">${aQ}</span></div>` : ''}
                        ${pQ > 0 ? `<div class="defect-card defect-pack"><strong>Packing:</strong> ${f['Pack Defect Details'].value} <span class="float-end badge bg-info text-dark">${pQ}</span></div>` : ''}
                        ${totalDefect == 0 ? '<div class="alert alert-success">No Defects Found - QC Passed</div>' : ''}
                    </div>
                </div>

                <!-- CAPA Section -->
                <div class="row">
                    <div class="col-12">
                         <h5 class="border-bottom pb-2">Action Plan</h5>
                         <div class="action-plan-box">
                            <p><strong>Problem:</strong> ${f['Problem Desc'].value}</p>
                            <p><strong>Root Cause:</strong> ${f['Root Cause'].value || 'Pending'}</p>
                            <p><strong>Corrective Action:</strong> ${f['Corrective Action'].value || 'Pending'}</p>
                         </div>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('dashboardContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('previewModal')).show();
    }

    // 4. Save to Google Sheet
    const form = document.forms['submit-to-google-sheet'];
    form.addEventListener('submit', e => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
        btn.disabled = true;

        fetch(scriptURL, { method: 'POST', body: new FormData(form)})
        .then(response => {
            alert("✅ Data Saved to Google Sheets Successfully!");
            form.reset();
            btn.innerHTML = '<i class="bi bi-cloud-upload"></i> Save to Cloud';
            btn.disabled = false;
        })
        .catch(error => {
            console.error('Error!', error.message);
            alert("⚠️ Check Google Sheet. Data might be saved despite this error."); 
            btn.disabled = false;
        });
    });

    // 5. Excel Download
    function downloadExcel() {
        const data = {};
        new FormData(form).forEach((value, key) => data[key] = value);
        const ws = XLSX.utils.json_to_sheet([data]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "PDI Data");
        XLSX.writeFile(wb, `PDI_${data.Model}_${data.Date}.xlsx`);
    }

    // 6. Professional PPT Download
    function downloadPPT() {
        let pres = new PptxGenJS();
        
        // Define Slide Master with Logo
        pres.defineSlideMaster({
            title: "MASTER_SLIDE",
            background: { color: "FFFFFF" },
            objects: [
                { rect: { x: 0, y: 0, w: "100%", h: 0.8, fill: "2C3E50" } }, // Header Bar
                { text: { text: "PDI PERFORMANCE REPORT", options: { x: 0.5, y: 0.2, color: "FFFFFF", fontSize: 18, bold: true } } },
                { image: { data: logoData, x: 8.5, y: 0.1, w: 1.2, h: 0.6 } } // Logo Top Right
            ]
        });

        let slide = pres.addSlide({ masterName: "MASTER_SLIDE" });

        // Get Form Data
        const fd = new FormData(form);
        const model = fd.get('Model');
        const date = fd.get('Date');
        
        // Slide Title
        slide.addText(`Model: ${model}  |  Date: ${date}`, { x: 0.5, y: 1.0, fontSize: 14, color: '666666' });

        // Draw Table for Metrics
        const rows = [
            [
                { text: "Lot Qty", options: { fill: "007BFF", color: "FFFFFF", align: "center", bold:true } },
                { text: "Sample Qty", options: { fill: "28A745", color: "FFFFFF", align: "center", bold:true } },
                { text: "Function Defect", options: { fill: "DC3545", color: "FFFFFF", align: "center", bold:true } },
                { text: "Total Defect", options: { fill: "343A40", color: "FFFFFF", align: "center", bold:true } }
            ],
            [
                fd.get('Lot Qty'), 
                fd.get('Sample Qty'), 
                fd.get('Func Qty'), 
                (Number(fd.get('Func Qty')) + Number(fd.get('Aes Qty')) + Number(fd.get('Pack Qty')))
            ]
        ];
        slide.addTable(rows, { x: 0.5, y: 1.5, w: 9, h: 1.0, align: "center", border: { pt: 1, color: "DDDDDD" } });

        // CAPA Section
        slide.addText("Problem Description:", { x: 0.5, y: 3.0, fontSize: 12, bold: true, color: "DC3545" });
        slide.addShape(pres.ShapeType.rect, { x: 0.5, y: 3.3, w: 9, h: 0.6, fill: "F8F9FA", line: "DDDDDD" });
        slide.addText(fd.get('Problem Desc'), { x: 0.6, y: 3.4, w: 8.8, fontSize: 11 });

        slide.addText("Root Cause Analysis:", { x: 0.5, y: 4.2, fontSize: 12, bold: true, color: "2C3E50" });
        slide.addShape(pres.ShapeType.rect, { x: 0.5, y: 4.5, w: 9, h: 0.8, fill: "F8F9FA", line: "DDDDDD" });
        slide.addText(fd.get('Root Cause'), { x: 0.6, y: 4.6, w: 8.8, fontSize: 11 });

        slide.addText("Corrective Action:", { x: 0.5, y: 5.5, fontSize: 12, bold: true, color: "2C3E50" });
        slide.addShape(pres.ShapeType.rect, { x: 0.5, y: 5.8, w: 9, h: 0.8, fill: "F8F9FA", line: "DDDDDD" });
        slide.addText(fd.get('Corrective Action'), { x: 0.6, y: 5.9, w: 8.8, fontSize: 11 });

        pres.writeFile({ fileName: `PDI_Report_${model}.pptx` });
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
