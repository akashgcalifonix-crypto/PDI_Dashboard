<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix Quality Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #002d72; --accent: #e31837; --bg: #f4f7f6; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; }
        
        /* Branding */
        .brand-text { font-weight: 800; font-size: 1.5rem; letter-spacing: 1px; color: var(--primary); }
        .brand-accent { color: var(--accent); }
        .navbar { background: #fff; border-bottom: 3px solid var(--accent); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        /* Cards */
        .card { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); margin-bottom: 15px; }
        .card-header { background: white; border-bottom: 1px solid #eee; font-weight: 700; color: #555; }
        .form-label { font-size: 0.85rem; font-weight: 600; color: #666; margin-bottom: 2px; }
        .form-control, .form-select { font-size: 0.9rem; border-color: #ddd; }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 0.2rem rgba(0, 45, 114, 0.1); }

        /* Evidence */
        .img-thumb { height: 60px; width: 60px; object-fit: cover; border: 1px solid #ddd; margin: 2px; border-radius: 4px; }

        /* Dashboard Table */
        .table thead { background-color: var(--primary); color: white; font-size: 0.9rem; }
        .btn-action { padding: 2px 8px; font-size: 0.8rem; }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar fixed-top">
    <div class="container-fluid px-4">
        <div class="d-flex align-items-center gap-2">
            <!-- CSS Logo to fix "Image not loading" issue -->
            <div class="brand-text">CALIF<span class="brand-accent">ONIX</span></div>
        </div>
        <ul class="nav nav-pills" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="tab-form" data-bs-toggle="pill" data-bs-target="#pills-form">New Entry</button></li>
            <li class="nav-item"><button class="nav-link" id="tab-dash" data-bs-toggle="pill" data-bs-target="#pills-dash" onclick="loadDashboard()">Live Dashboard</button></li>
        </ul>
    </div>
</nav>

<div class="container" style="margin-top: 80px; padding-bottom: 50px;">
    <div class="tab-content">
        
        <!-- === FORM TAB === -->
        <div class="tab-pane fade show active" id="pills-form">
            <form id="pdiForm">
                <input type="hidden" name="action" id="formAction" value="save">
                <input type="hidden" name="editRowId" id="editRowId">

                <!-- 1. General Info -->
                <div class="card">
                    <div class="card-header text-primary"><i class="bi bi-info-circle-fill me-2"></i>General Information</div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-2"><label class="form-label">Date</label><input type="date" name="Date" class="form-control" required></div>
                            <div class="col-md-2"><label class="form-label">Model</label><input type="text" name="Model" class="form-control" required></div>
                            <div class="col-md-2"><label class="form-label">Line No</label><input type="text" name="Line No" class="form-control" required></div>
                            <div class="col-md-2"><label class="form-label">Colour</label><input type="text" name="Colour" class="form-control"></div>
                            <div class="col-md-2"><label class="form-label">Lot Qty</label><input type="number" name="Lot Qty" class="form-control"></div>
                            <div class="col-md-2"><label class="form-label">Sample Qty</label><input type="number" name="Sample Qty" id="sampleQty" class="form-control" oninput="calc()"></div>
                        </div>
                        <div class="row g-2 mt-1 bg-light p-2 rounded">
                            <div class="col-md-2"><label class="form-label text-danger">Total Defects</label><input type="text" name="Total Defect" id="totalDefect" class="form-control fw-bold text-danger" readonly></div>
                            <div class="col-md-2"><label class="form-label text-danger">SRR %</label><input type="text" name="SRR" id="srrRate" class="form-control fw-bold text-danger" readonly></div>
                        </div>
                    </div>
                </div>

                <!-- 2. Defects -->
                <div class="card">
                    <div class="card-header text-danger"><i class="bi bi-bug-fill me-2"></i>Defect Breakdown</div>
                    <div class="card-body p-2">
                        <table class="table table-borderless m-0">
                            <tr>
                                <td width="15%" class="fw-bold">Function</td>
                                <td><input type="text" name="Func Details" id="fDet" class="form-control form-control-sm" placeholder="Detail..."></td>
                                <td width="10%"><input type="number" name="Func Qty" id="fQty" class="form-control form-control-sm" placeholder="Qty" oninput="calc()"></td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Aesthetic</td>
                                <td><input type="text" name="Aes Details" id="aDet" class="form-control form-control-sm" placeholder="Detail..."></td>
                                <td><input type="number" name="Aes Qty" id="aQty" class="form-control form-control-sm" placeholder="Qty" oninput="calc()"></td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Packing</td>
                                <td><input type="text" name="Pack Details" id="pDet" class="form-control form-control-sm" placeholder="Detail..."></td>
                                <td><input type="number" name="Pack Qty" id="pQty" class="form-control form-control-sm" placeholder="Qty" oninput="calc()"></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- 3. Process Traceability -->
                <div class="card">
                    <div class="card-header text-success"><i class="bi bi-clock-history me-2"></i>Traceability</div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-3"><label class="form-label">Master Carton</label><input type="datetime-local" name="MC Date" class="form-control"></div>
                            <div class="col-md-3"><label class="form-label">LQC Date</label><input type="datetime-local" name="LQC Date" class="form-control"></div>
                            <div class="col-md-3"><label class="form-label">LQC Name</label><input type="text" name="LQC Name" class="form-control"></div>
                            <div class="col-md-3"><label class="form-label">Belongs To</label><select name="Belongs To" class="form-select"><option>Buds</option><option>Case</option></select></div>
                            <div class="col-md-3"><label class="form-label">FT Date</label><input type="datetime-local" name="FT Date" class="form-control"></div>
                            <div class="col-md-3"><label class="form-label">FT Name</label><input type="text" name="FT Name" class="form-control"></div>
                            <div class="col-md-3"><label class="form-label">BT Attempt</label><select name="BT Attempt" class="form-select"><option>Yes</option><option>No</option></select></div>
                            <div class="col-md-3"><label class="form-label">RF Attempt</label><select name="RF Attempt" class="form-select"><option>Yes</option><option>No</option></select></div>
                        </div>
                    </div>
                </div>

                <!-- 4. CAPA & Evidence -->
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">Action Plan</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <label class="form-label">Team Formation</label><input type="text" name="Team" class="form-control mb-2">
                                <label class="form-label fw-bold">Problem (Auto)</label><input type="text" name="Problem" id="problemDesc" class="form-control mb-2 bg-light fw-bold" readonly>
                                <label class="form-label">Root Cause</label><textarea name="Root Cause" class="form-control mb-2" rows="1"></textarea>
                                <label class="form-label">Corrective Action</label><textarea name="Corrective" class="form-control mb-2" rows="1"></textarea>
                                <label class="form-label">Preventive Action</label><textarea name="Preventive" class="form-control" rows="1"></textarea>
                            </div>
                            <div class="col-md-4 border-start text-center">
                                <label class="form-label fw-bold d-block">Upload Evidence (Multiple)</label>
                                <input type="file" id="evidenceInput" class="form-control mb-2" accept="image/*" multiple onchange="handleEvidence()">
                                <div id="evidencePreviewBox" class="d-flex flex-wrap justify-content-center gap-1"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="d-flex justify-content-end gap-2 my-4">
                    <button type="button" class="btn btn-warning" onclick="resetForm()">Clear</button>
                    <button type="button" class="btn btn-info text-white" onclick="showFullPreview()">Preview Full Report</button>
                    <button type="submit" class="btn btn-success px-4" id="saveBtn">Save Record</button>
                </div>
            </form>
        </div>

        <!-- === DASHBOARD TAB === -->
        <div class="tab-pane fade" id="pills-dash">
            <div class="card p-3">
                <div class="row g-2 align-items-end mb-3">
                    <div class="col-md-3"><label class="form-label">From Date</label><input type="date" id="filterStart" class="form-control"></div>
                    <div class="col-md-3"><label class="form-label">To Date</label><input type="date" id="filterEnd" class="form-control"></div>
                    <div class="col-md-3"><button class="btn btn-primary w-100" onclick="loadDashboard()">Apply Filter</button></div>
                    <div class="col-md-3"><button class="btn btn-outline-secondary w-100" onclick="loadDashboard()">Show All</button></div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover table-bordered text-center align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Date</th><th>Model</th><th>Line</th><th>Total Defect</th><th>Action Plan</th><th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dashData"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Full Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Inspection Report Preview</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-white" id="previewContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="downloadPPT()"><i class="bi bi-file-ppt-fill"></i> Download Professional PPT</button>
            </div>
        </div>
    </div>
</div>

<script>
    // URL REPLACE KAREIN
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz_s1aGTlzKo__fW9j4lrqeyXwKJjmQjXVQKj0CIVdOK_940lsaMXYbSXdgaOrduhEX/exec'; 
    
    let evidenceImages = []; // Stores Base64 strings

    // 1. Evidence Handling (Multiple)
    function handleEvidence() {
        const files = document.getElementById('evidenceInput').files;
        const previewBox = document.getElementById('evidencePreviewBox');
        previewBox.innerHTML = '';
        evidenceImages = [];

        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = e => {
                evidenceImages.push(e.target.result);
                previewBox.innerHTML += `<img src="${e.target.result}" class="img-thumb">`;
            };
            reader.readAsDataURL(file);
        });
    }

    // 2. Calculation & Problem Auto-Fill
    function calc() {
        const f = Number(document.getElementById('fQty').value) || 0;
        const a = Number(document.getElementById('aQty').value) || 0;
        const p = Number(document.getElementById('pQty').value) || 0;
        const sample = Number(document.getElementById('sampleQty').value) || 0;
        
        const total = f + a + p;
        document.getElementById('totalDefect').value = total;
        document.getElementById('srrRate').value = sample > 0 ? ((total/sample)*100).toFixed(2) + '%' : '0%';

        let prob = "No Major Issues";
        if (f > 0) prob = `Function: ${document.getElementById('fDet').value} (${f})`;
        else if (a > 0) prob = `Aesthetic: ${document.getElementById('aDet').value} (${a})`;
        else if (p > 0) prob = `Packing: ${document.getElementById('pDet').value} (${p})`;
        document.getElementById('problemDesc').value = prob;
    }

    // 3. Save / Update Logic
    const form = document.getElementById('pdiForm');
    form.addEventListener('submit', e => {
        e.preventDefault();
        const btn = document.getElementById('saveBtn');
        btn.innerText = "Saving..."; btn.disabled = true;

        fetch(SCRIPT_URL, { method: 'POST', body: new FormData(form) })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            resetForm();
            btn.innerText = "Save Record"; btn.disabled = false;
        })
        .catch(err => { alert("Error saving data"); btn.disabled = false; });
    });

    function resetForm() {
        form.reset();
        document.getElementById('formAction').value = 'save';
        document.getElementById('editRowId').value = '';
        document.getElementById('saveBtn').innerText = "Save Record";
        document.getElementById('saveBtn').classList.remove('btn-warning');
        document.getElementById('saveBtn').classList.add('btn-success');
        document.getElementById('evidencePreviewBox').innerHTML = '';
        evidenceImages = [];
    }

    // 4. Dashboard (Filter, Load, Edit, Delete)
    function loadDashboard() {
        const tbody = document.getElementById('dashData');
        tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
        
        const start = document.getElementById('filterStart').value;
        const end = document.getElementById('filterEnd').value;

        fetch(SCRIPT_URL)
        .then(res => res.json())
        .then(json => {
            tbody.innerHTML = '';
            // Data Structure: [RowID, Date, Model, Line, Colour, Lot, Sample, Total, SRR, ...]
            // Index Mapping: 0=ID, 1=Date, 2=Model, 3=Line, 7=Total, 24=Problem
            
            const rows = json.data.filter(row => {
                if(!start || !end) return true;
                return row[1] >= start && row[1] <= end;
            });

            if(rows.length === 0) tbody.innerHTML = '<tr><td colspan="6">No Data Found</td></tr>';

            rows.forEach(row => {
                let jsonRow = encodeURIComponent(JSON.stringify(row));
                tbody.innerHTML += `
                    <tr>
                        <td>${row[1]}</td>
                        <td>${row[2]}</td>
                        <td>${row[3]}</td>
                        <td><span class="badge bg-danger">${row[7]}</span></td>
                        <td class="small text-start">${row[24]}</td>
                        <td>
                            <button class="btn btn-warning btn-action" onclick="editRecord('${jsonRow}')">Edit</button>
                            <button class="btn btn-danger btn-action" onclick="deleteRecord(${row[0]})">Del</button>
                            <button class="btn btn-success btn-action" onclick="pptFromRow('${jsonRow}')">PPT</button>
                        </td>
                    </tr>
                `;
            });
        });
    }

    function editRecord(rowStr) {
        const row = JSON.parse(decodeURIComponent(rowStr));
        // Switch to form
        document.getElementById('tab-form').click();
        
        // Populate fields (Indices based on Google Sheet order)
        document.getElementById('formAction').value = 'edit';
        document.getElementById('editRowId').value = row[0];
        
        const inputs = form.elements;
        inputs['Date'].value = row[1];
        inputs['Model'].value = row[2];
        inputs['Line No'].value = row[3];
        inputs['Colour'].value = row[4];
        inputs['Lot Qty'].value = row[5];
        inputs['Sample Qty'].value = row[6];
        inputs['Total Defect'].value = row[7];
        inputs['SRR'].value = row[8];
        inputs['Func Details'].value = row[9]; inputs['Func Qty'].value = row[10];
        inputs['Aes Details'].value = row[11]; inputs['Aes Qty'].value = row[12];
        inputs['Pack Details'].value = row[13]; inputs['Pack Qty'].value = row[14];
        inputs['MC Date'].value = row[15];
        inputs['LQC Date'].value = row[16]; inputs['LQC Name'].value = row[17];
        inputs['FT Date'].value = row[18]; inputs['FT Name'].value = row[19];
        inputs['Belongs To'].value = row[20];
        inputs['BT Attempt'].value = row[21];
        inputs['RF Attempt'].value = row[22];
        inputs['Team'].value = row[23];
        inputs['Problem'].value = row[24];
        inputs['Root Cause'].value = row[25];
        inputs['Corrective'].value = row[26];
        inputs['Preventive'].value = row[27];

        const btn = document.getElementById('saveBtn');
        btn.innerText = "Update Record";
        btn.classList.remove('btn-success');
        btn.classList.add('btn-warning');
    }

    function deleteRecord(id) {
        if(!confirm("Are you sure?")) return;
        const fd = new FormData();
        fd.append('action', 'delete');
        fd.append('rowIndex', id);
        fetch(SCRIPT_URL, { method:'POST', body:fd }).then(() => loadDashboard());
    }

    // 5. Preview Full Details
    function showFullPreview() {
        const fd = new FormData(form);
        let html = `
            <div class="border p-4">
                <div class="d-flex justify-content-between border-bottom pb-2 mb-3">
                    <h2 class="text-primary fw-bold">CALIF<span class="text-danger">ONIX</span></h2>
                    <div class="text-end">
                        <h5>PDI REPORT</h5>
                        <small>Date: ${fd.get('Date')} | Model: ${fd.get('Model')}</small>
                    </div>
                </div>
                
                <table class="table table-bordered table-sm text-center">
                    <tr class="table-secondary"><th>Line</th><th>Lot Qty</th><th>Sample</th><th>Defects</th><th>SRR</th></tr>
                    <tr><td>${fd.get('Line No')}</td><td>${fd.get('Lot Qty')}</td><td>${fd.get('Sample Qty')}</td><td class="text-danger fw-bold">${fd.get('Total Defect')}</td><td>${fd.get('SRR')}</td></tr>
                </table>

                <h6 class="text-primary mt-3 border-bottom">Defect Analysis</h6>
                <table class="table table-sm table-bordered">
                    <tr><th>Type</th><th>Details</th><th>Qty</th></tr>
                    <tr><td>Function</td><td>${fd.get('Func Details')}</td><td>${fd.get('Func Qty')}</td></tr>
                    <tr><td>Aesthetic</td><td>${fd.get('Aes Details')}</td><td>${fd.get('Aes Qty')}</td></tr>
                    <tr><td>Packing</td><td>${fd.get('Pack Details')}</td><td>${fd.get('Pack Qty')}</td></tr>
                </table>

                <h6 class="text-primary mt-3 border-bottom">Action Plan</h6>
                <table class="table table-bordered table-sm">
                    <tr><td width="30%" class="bg-light fw-bold">Problem</td><td>${fd.get('Problem')}</td></tr>
                    <tr><td class="bg-light fw-bold">Root Cause</td><td>${fd.get('Root Cause')}</td></tr>
                    <tr><td class="bg-light fw-bold">Corrective Action</td><td>${fd.get('Corrective')}</td></tr>
                    <tr><td class="bg-light fw-bold">Preventive Action</td><td>${fd.get('Preventive')}</td></tr>
                </table>

                <h6 class="text-primary mt-3">Evidence</h6>
                <div class="d-flex gap-2">
                    ${evidenceImages.map(img => `<img src="${img}" style="height:100px; border:1px solid #ccc">`).join('')}
                </div>
            </div>
        `;
        document.getElementById('previewContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('previewModal')).show();
    }

    // 6. Professional PPT (Full Details + Images)
    function downloadPPT() {
        // Collect data from Form
        const fd = new FormData(form);
        const dataObj = {};
        fd.forEach((v,k) => dataObj[k] = v);
        generatePPT(dataObj, evidenceImages);
    }

    function pptFromRow(jsonStr) {
        const row = JSON.parse(decodeURIComponent(jsonStr));
        // Map Array to Object keys manually
        const dataObj = {
            'Date': row[1], 'Model': row[2], 'Line No': row[3], 'Lot Qty': row[5], 'Sample Qty': row[6],
            'Total Defect': row[7], 'SRR': row[8],
            'Func Details': row[9], 'Func Qty': row[10], 'Aes Details': row[11], 'Aes Qty': row[12], 'Pack Details': row[13], 'Pack Qty': row[14],
            'MC Date': row[15], 'LQC Name': row[17], 'FT Name': row[19],
            'Problem': row[24], 'Root Cause': row[25], 'Corrective': row[26], 'Preventive': row[27]
        };
        // Note: Dashboard doesn't store images in sheet (too heavy), so passing empty array
        generatePPT(dataObj, []); 
    }

    function generatePPT(data, images) {
        let pres = new PptxGenJS();
        
        // Master Slide with Califonix Branding
        pres.defineSlideMaster({
            title: "CALIFONIX_MASTER",
            background: { color: "FFFFFF" },
            objects: [
                { rect: { x: 0, y: 0, w: "100%", h: 0.8, fill: "002d72" } },
                { text: { text: "CALIFONIX QUALITY REPORT", options: { x: 0.5, y: 0.2, color: "FFFFFF", fontSize: 18, bold: true } } },
                { line: { x: 0, y: 5.2, w: "100%", h: 0, line: "e31837", lineSize: 3 } } // Bottom Red Line
            ]
        });

        let slide = pres.addSlide({ masterName: "CALIFONIX_MASTER" });

        // Header Info
        slide.addText(`Model: ${data['Model']}   |   Date: ${data['Date']}   |   Line: ${data['Line No']}`, 
            { x: 0.5, y: 1.0, fontSize: 14, color: "444444", bold: true });

        // 1. Metrics Table
        let headers = [['Lot Qty', 'Sample Qty', 'Total Defect', 'SRR %']];
        let values = [[data['Lot Qty'], data['Sample Qty'], data['Total Defect'], data['SRR']]];
        
        slide.addTable([...headers, ...values], {
            x: 0.5, y: 1.4, w: 9, align: 'center',
            fill: { color: "F7F7F7" }, border: { color: "CCCCCC" },
            color: "333333", fontSize: 12
        });

        // 2. Defect Breakdown
        slide.addText("Defect Breakdown", { x: 0.5, y: 2.3, fontSize: 12, color: "002d72", bold: true });
        let defectText = `Function: ${data['Func Details']} (${data['Func Qty']})\n` +
                         `Aesthetic: ${data['Aes Details']} (${data['Aes Qty']})\n` +
                         `Packing: ${data['Pack Details']} (${data['Pack Qty']})`;
        slide.addText(defectText, { x: 0.5, y: 2.5, w: 9, h: 1.0, fontSize: 11, color: "333333", shape: pres.ShapeType.rect, fill: "FFFFFF", line: "DDDDDD" });

        // 3. Traceability & Action Plan
        slide.addText("Traceability & Action Plan", { x: 0.5, y: 3.7, fontSize: 12, color: "002d72", bold: true });
        let traceText = `MC Date: ${data['MC Date']}  |  LQC: ${data['LQC Name']}  |  FT: ${data['FT Name']}`;
        slide.addText(traceText, { x: 0.5, y: 3.9, w: 9, fontSize: 10, italic: true, color: "666666" });

        let capTable = [
            [{ text: "Problem", bold:true }, data['Problem']],
            [{ text: "Root Cause", bold:true }, data['Root Cause']],
            [{ text: "Corrective Action", bold:true }, data['Corrective']],
            [{ text: "Preventive", bold:true }, data['Preventive']]
        ];
        slide.addTable(capTable, { x: 0.5, y: 4.2, w: 6, colW: [1.5, 4.5], fontSize: 10, border: { color: "AAAAAA" } });

        // 4. Evidence Images (Right Side)
        if (images && images.length > 0) {
            slide.addText("Evidence", { x: 6.8, y: 3.7, fontSize: 11, bold: true });
            // Add up to 2 images stacked
            if(images[0]) slide.addImage({ data: images[0], x: 6.8, y: 4.0, w: 2.5, h: 1.5 });
            if(images[1]) slide.addImage({ data: images[1], x: 6.8, y: 5.6, w: 2.5, h: 1.5 }); // Might overlap bottom line, adjust if needed
        }

        pres.writeFile({ fileName: `PDI_${data['Model']}_${data['Date']}.pptx` });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
