<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDI Performance Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body { background-color: #f4f6f9; padding: 20px; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .section-title { background-color: #007bff; color: white; padding: 10px; border-radius: 5px 5px 0 0; }
        .logo-preview { max-height: 80px; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="text-center mb-4">
        <!-- Logo Upload Section -->
        <img id="displayLogo" class="logo-preview mx-auto">
        <h2 class="mt-2">PDI Performance Dashboard</h2>
        <div class="mb-3 w-50 mx-auto">
            <label class="form-label text-muted small">Upload Company Logo (for PPT & Preview)</label>
            <input type="file" id="logoInput" class="form-control form-control-sm" accept="image/*" onchange="handleLogoUpload()">
        </div>
    </div>

    <form id="pdiForm" name="submit-to-google-sheet">
        
        <!-- 1. General Information -->
        <div class="card">
            <div class="section-title"><h5>General Info</h5></div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3"><label>Date</label><input type="date" name="Date" class="form-control" required></div>
                    <div class="col-md-3"><label>Model</label><input type="text" name="Model" class="form-control" required></div>
                    <div class="col-md-3"><label>Colour</label><input type="text" name="Colour" class="form-control" required></div>
                    <div class="col-md-3"><label>Lot Qty</label><input type="number" name="Lot Qty" class="form-control"></div>
                    <div class="col-md-3"><label>Sample Qty</label><input type="number" name="Sample Qty" class="form-control"></div>
                </div>
            </div>
        </div>

        <!-- 2. Defect Details -->
        <div class="card">
            <div class="section-title"><h5>Defect Information</h5></div>
            <div class="card-body">
                <!-- Function -->
                <div class="row g-3 mb-2 border-bottom pb-2">
                    <div class="col-md-2"><strong>Function</strong></div>
                    <div class="col-md-7"><input type="text" name="Func Defect Details" id="funcDetail" class="form-control" placeholder="Defect Details"></div>
                    <div class="col-md-3"><input type="number" name="Func Qty" id="funcQty" class="form-control" placeholder="Qty" oninput="checkPriority()"></div>
                </div>
                <!-- Aesthetics -->
                <div class="row g-3 mb-2 border-bottom pb-2">
                    <div class="col-md-2"><strong>Aesthetics</strong></div>
                    <div class="col-md-7"><input type="text" name="Aes Defect Details" id="aesDetail" class="form-control" placeholder="Defect Details"></div>
                    <div class="col-md-3"><input type="number" name="Aes Qty" id="aesQty" class="form-control" placeholder="Qty" oninput="checkPriority()"></div>
                </div>
                <!-- Packing -->
                <div class="row g-3">
                    <div class="col-md-2"><strong>Packing</strong></div>
                    <div class="col-md-7"><input type="text" name="Pack Defect Details" id="packDetail" class="form-control" placeholder="Defect Details"></div>
                    <div class="col-md-3"><input type="number" name="Pack Qty" id="packQty" class="form-control" placeholder="Qty" oninput="checkPriority()"></div>
                </div>
            </div>
        </div>

        <!-- 3. Process Details -->
        <div class="card">
            <div class="section-title"><h5>Process & Operator Details</h5></div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6"><label>Master Carton Date & Time</label><input type="datetime-local" name="Master Carton Date" class="form-control"></div>
                    <div class="col-md-3"><label>LQC Date & Time</label><input type="datetime-local" name="LQC Date" class="form-control"></div>
                    <div class="col-md-3"><label>LQC Operator Name</label><input type="text" name="LQC Name" class="form-control"></div>
                    <div class="col-md-3"><label>FT Date & Time</label><input type="datetime-local" name="FT Date" class="form-control"></div>
                    <div class="col-md-3"><label>FT Operator Name</label><input type="text" name="FT Name" class="form-control"></div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-4">
                        <label>Defect Belongs To</label>
                        <select name="Defect Belongs To" class="form-select">
                            <option value="Buds">Buds</option>
                            <option value="Charging">Charging Case</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>BT Attempt</label>
                        <select name="BT Attempt" class="form-select">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>RF Attempt</label>
                        <select name="RF Attempt" class="form-select">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. Major Defect Action Plan -->
        <div class="card border-danger">
            <div class="section-title bg-danger"><h5>Major Defect Action Plan</h5></div>
            <div class="card-body">
                <div class="mb-3">
                    <label>1. Team Formation</label>
                    <input type="text" name="Team Formation" class="form-control">
                </div>
                <div class="mb-3">
                    <label>2. Problem Description (Auto-Filled)</label>
                    <textarea name="Problem Desc" id="problemDesc" class="form-control" readonly></textarea>
                </div>
                <div class="mb-3">
                    <label>3. Root Cause Analysis</label>
                    <textarea name="Root Cause" class="form-control"></textarea>
                </div>
                <div class="mb-3">
                    <label>4. Corrective Action</label>
                    <textarea name="Corrective Action" class="form-control"></textarea>
                </div>
                <div class="mb-3">
                    <label>5. Preventive Action</label>
                    <textarea name="Preventive Action" class="form-control"></textarea>
                </div>
            </div>
        </div>

        <!-- Buttons -->
        <div class="d-flex justify-content-between mb-5">
            <button type="button" class="btn btn-warning" onclick="previewData()">Preview Data</button>
            <div>
                <button type="button" class="btn btn-success" onclick="downloadExcel()">Download Excel</button>
                <button type="button" class="btn btn-primary" onclick="downloadPPT()">Download PPT</button>
                <button type="submit" class="btn btn-dark" id="submitBtn">Save to Google Sheet</button>
            </div>
        </div>
    </form>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Preview Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
            <img id="previewLogoModal" style="max-height: 80px; display: none;">
        </div>
        <div id="previewContent"></div>
      </div>
    </div>
  </div>
</div>

<script>
    // --- Global Variable for Logo ---
    let logoBase64 = null;

    // --- 1. Handle Logo Upload ---
    function handleLogoUpload() {
        const fileInput = document.getElementById('logoInput');
        const file = fileInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                logoBase64 = e.target.result; // Save base64 string
                
                // Show logo on main page
                const displayImg = document.getElementById('displayLogo');
                displayImg.src = logoBase64;
                displayImg.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }

    // --- 2. Logic for Auto-filling Action Plan ---
    function checkPriority() {
        const funcQty = document.getElementById('funcQty').value;
        const aesQty = document.getElementById('aesQty').value;
        const packQty = document.getElementById('packQty').value;
        
        const funcDetail = document.getElementById('funcDetail').value;
        const aesDetail = document.getElementById('aesDetail').value;
        const packDetail = document.getElementById('packDetail').value;

        let problem = "No Major Defect";

        if (funcQty && funcQty > 0) {
            problem = "FUNCTION DEFECT: " + funcDetail + " (Qty: " + funcQty + ")";
        } else if (aesQty && aesQty > 0) {
            problem = "AESTHETIC DEFECT: " + aesDetail + " (Qty: " + aesQty + ")";
        } else if (packQty && packQty > 0) {
            problem = "PACKING DEFECT: " + packDetail + " (Qty: " + packQty + ")";
        }

        document.getElementById('problemDesc').value = problem;
    }

    // --- 3. Google Sheet Submission ---
    // !!! REPLACE THIS URL WITH YOUR NEW WEB APP URL !!!
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxUi5cHC8awxTYjZNx3Q04zY3zf5AFi33POoZVS0izMs-GmR-sy3oUeG3gysDdhM_Y/exec'; 
    
    const form = document.forms['submit-to-google-sheet'];

    form.addEventListener('submit', e => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "Saving...";

        fetch(scriptURL, { method: 'POST', body: new FormData(form)})
        .then(response => {
            alert("Data Saved Successfully!");
            form.reset();
            // Reset Logo
            logoBase64 = null;
            document.getElementById('displayLogo').style.display = 'none';
            btn.disabled = false;
            btn.innerText = "Save to Google Sheet";
        })
        .catch(error => {
            console.error('Error!', error.message);
            // Sometimes it saves but returns error due to CORS, check sheet
            alert("Check Google Sheet. If data is there, ignore this error."); 
            btn.disabled = false;
        });
    });

    // --- 4. Preview Logic ---
    function previewData() {
        const formData = new FormData(form);
        let html = "<table class='table table-bordered'>";
        for (const [key, value] of formData) {
            if(value && key !== "Data") html += `<tr><th>${key}</th><td>${value}</td></tr>`;
        }
        html += "</table>";
        
        // Handle Logo in Preview
        const imgModal = document.getElementById('previewLogoModal');
        if(logoBase64) {
            imgModal.src = logoBase64;
            imgModal.style.display = 'inline-block';
        } else {
            imgModal.style.display = 'none';
        }

        document.getElementById('previewContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('previewModal')).show();
    }

    // --- 5. Excel Download ---
    function downloadExcel() {
        const formData = new FormData(form);
        const data = {};
        formData.forEach((value, key) => { data[key] = value });
        
        const ws = XLSX.utils.json_to_sheet([data]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "PDI Data");
        XLSX.writeFile(wb, "PDI_Report.xlsx");
    }

    // --- 6. PPT Download (With Logo) ---
    function downloadPPT() {
        let pres = new PptxGenJS();
        let slide1 = pres.addSlide();

        // Add Logo to Slide if exists
        if (logoBase64) {
            slide1.addImage({ data: logoBase64, x: 0.5, y: 0.2, w: 1.5, h: 0.8 });
        }

        // Title
        slide1.addText("PDI Performance Report", { x: 2.5, y: 0.5, fontSize: 24, bold: true, color: '363636' });
        
        const model = document.querySelector('[name="Model"]').value;
        const date = document.querySelector('[name="Date"]').value;
        const problem = document.getElementById('problemDesc').value;
        const rca = document.querySelector('[name="Root Cause"]').value;
        const capa = document.querySelector('[name="Corrective Action"]').value;
        const team = document.querySelector('[name="Team Formation"]').value;

        // General Info Box
        slide1.addText(`Date: ${date}   |   Model: ${model}`, { x: 0.5, y: 1.3, fontSize: 14, color: '666666' });
        
        // Sections
        let yPos = 2.0;
        
        slide1.addText("1. Team Formation:", { x: 0.5, y: yPos, fontSize: 14, bold: true, color:'007bff' });
        slide1.addText(team || "N/A", { x: 0.5, y: yPos+0.3, w: 9, fontSize: 12 });
        yPos += 1.0;

        slide1.addText("2. Problem Description:", { x: 0.5, y: yPos, fontSize: 14, bold: true, color:'007bff' });
        slide1.addText(problem, { x: 0.5, y: yPos+0.3, w: 9, fontSize: 12 });
        yPos += 1.0;

        slide1.addText("3. Root Cause Analysis:", { x: 0.5, y: yPos, fontSize: 14, bold: true, color:'007bff' });
        slide1.addText(rca || "N/A", { x: 0.5, y: yPos+0.3, w: 9, fontSize: 12 });
        yPos += 1.0;

        slide1.addText("4. Corrective Action:", { x: 0.5, y: yPos, fontSize: 14, bold: true, color:'007bff' });
        slide1.addText(capa || "N/A", { x: 0.5, y: yPos+0.3, w: 9, fontSize: 12 });

        pres.writeFile({ fileName: `PDI_Report_${model}.pptx` });
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
