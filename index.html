<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix Quality Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #0d6efd; --light-bg: #f0f2f5; --card-bg: #ffffff; }
        body { background-color: var(--light-bg); font-family: 'Segoe UI', sans-serif; }
        
        /* Glassy Header */
        .navbar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #e0e0e0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo-img { height: 50px; }

        /* Modern Cards */
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); margin-bottom: 20px; background: var(--card-bg); }
        .section-title { font-size: 0.9rem; font-weight: 700; color: #6c757d; text-transform: uppercase; letter-spacing: 1px; padding: 15px 20px; border-bottom: 1px solid #f0f0f0; }
        
        /* Inputs */
        .form-control, .form-select { border-radius: 8px; border: 1px solid #dee2e6; background-color: #f8f9fa; }
        .form-control:focus { background-color: #fff; box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15); }
        .auto-calc { background-color: #e8f4fd; color: #0d6efd; font-weight: 600; border: 1px solid #b6d4fe; }

        /* Dashboard Table */
        .table-custom th { background-color: #eef2f7; color: #555; font-weight: 600; }
        .table-custom td { vertical-align: middle; }
        
        /* Evidence Preview */
        #evidencePreviewImg { max-height: 150px; border-radius: 8px; border: 2px dashed #ccc; display: none; margin-top: 10px; }
    </style>
</head>
<body>

<!-- Navigation -->
<nav class="navbar fixed-top">
    <div class="container">
        <div class="d-flex align-items-center gap-3">
            <img src="logo.png" id="navLogo" class="logo-img" alt="Logo" onerror="this.style.display='none'">
            <div>
                <h5 class="m-0 fw-bold text-dark">Califonix PDI Tool</h5>
                <small class="text-muted">Quality Assurance Dashboard</small>
            </div>
        </div>
        <ul class="nav nav-pills" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active rounded-pill" id="tab-form" data-bs-toggle="pill" data-bs-target="#pills-home" type="button">New Inspection</button></li>
            <li class="nav-item"><button class="nav-link rounded-pill" id="tab-dash" data-bs-toggle="pill" data-bs-target="#pills-profile" type="button" onclick="loadDashboard()">Live Dashboard</button></li>
        </ul>
    </div>
</nav>

<div class="container" style="margin-top: 100px; padding-bottom: 50px;">
    <div class="tab-content" id="pills-tabContent">
        
        <!-- === TAB 1: NEW ENTRY FORM === -->
        <div class="tab-pane fade show active" id="pills-home">
            <form id="pdiForm">
                
                <!-- General Info -->
                <div class="card">
                    <div class="section-title text-primary"><i class="bi bi-grid-fill me-2"></i>General Info</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-2"><label>Date</label><input type="date" name="Date" class="form-control" required></div>
                            <div class="col-md-3"><label>Model</label><input type="text" name="Model" class="form-control" placeholder="e.g. Earbuds" required></div>
                            <div class="col-md-2"><label>Colour</label><input type="text" name="Colour" class="form-control" required></div>
                            <div class="col-md-2"><label>Line No</label><input type="text" name="Line No" class="form-control" required></div>
                            <div class="col-md-3"><label>Lot Qty</label><input type="number" name="Lot Qty" class="form-control"></div>
                            
                            <div class="col-md-2"><label>Sample Qty</label><input type="number" name="Sample Qty" id="sampleQty" class="form-control" oninput="calc()"></div>
                            <div class="col-md-2"><label>Total Defect</label><input type="text" name="Total Defect Qty" id="totalDefect" class="form-control auto-calc" readonly></div>
                            <div class="col-md-2"><label>SRR %</label><input type="text" name="SRR %" id="srrRate" class="form-control auto-calc" readonly></div>
                        </div>
                    </div>
                </div>

                <!-- Defects -->
                <div class="card">
                    <div class="section-title text-danger"><i class="bi bi-bug-fill me-2"></i>Defect Details</div>
                    <div class="card-body">
                        <div class="row g-2 align-items-center mb-2">
                            <div class="col-2 fw-bold text-danger">Function</div>
                            <div class="col-8"><input type="text" name="Func Defect Details" id="fDet" class="form-control" placeholder="Issue description..."></div>
                            <div class="col-2"><input type="number" name="Func Qty" id="fQty" class="form-control" placeholder="0" oninput="calc()"></div>
                        </div>
                        <div class="row g-2 align-items-center mb-2">
                            <div class="col-2 fw-bold text-warning">Aesthetic</div>
                            <div class="col-8"><input type="text" name="Aes Defect Details" id="aDet" class="form-control" placeholder="Issue description..."></div>
                            <div class="col-2"><input type="number" name="Aes Qty" id="aQty" class="form-control" placeholder="0" oninput="calc()"></div>
                        </div>
                        <div class="row g-2 align-items-center">
                            <div class="col-2 fw-bold text-info">Packing</div>
                            <div class="col-8"><input type="text" name="Pack Defect Details" id="pDet" class="form-control" placeholder="Issue description..."></div>
                            <div class="col-2"><input type="number" name="Pack Qty" id="pQty" class="form-control" placeholder="0" oninput="calc()"></div>
                        </div>
                    </div>
                </div>

                <!-- Process -->
                <div class="card">
                    <div class="section-title text-success"><i class="bi bi-clipboard-check-fill me-2"></i>Traceability</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4"><label>Master Carton Date</label><input type="datetime-local" name="Master Carton Date" class="form-control"></div>
                            <div class="col-md-4"><label>LQC (Date/Name)</label><div class="input-group"><input type="datetime-local" name="LQC Date" class="form-control"><input type="text" name="LQC Name" class="form-control" placeholder="Name"></div></div>
                            <div class="col-md-4"><label>FT (Date/Name)</label><div class="input-group"><input type="datetime-local" name="FT Date" class="form-control"><input type="text" name="FT Name" class="form-control" placeholder="Name"></div></div>
                            <div class="col-md-4"><label>Defect Belongs To</label><select name="Defect Belongs To" class="form-select"><option>Buds</option><option>Case</option><option>Accessory</option></select></div>
                            <div class="col-md-4"><label>BT Attempt</label><select name="BT Attempt" class="form-select"><option>Yes</option><option>No</option></select></div>
                            <div class="col-md-4"><label>RF Attempt</label><select name="RF Attempt" class="form-select"><option>Yes</option><option>No</option></select></div>
                        </div>
                    </div>
                </div>

                <!-- Action Plan & Evidence -->
                <div class="card border-0 shadow-sm" style="background: #fff5f5;">
                    <div class="section-title text-danger"><i class="bi bi-shield-exclamation me-2"></i>Action Plan & Evidence</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <label class="fw-bold">Team Formation</label>
                                <input type="text" name="Team Formation" class="form-control mb-2">
                                
                                <label class="fw-bold text-danger">Problem Description (Auto)</label>
                                <input type="text" name="Problem Desc" id="problemDesc" class="form-control mb-2 fw-bold bg-white" readonly>

                                <label class="fw-bold">Root Cause</label>
                                <textarea name="Root Cause" class="form-control mb-2" rows="2"></textarea>
                                
                                <label class="fw-bold">Corrective Action</label>
                                <textarea name="Corrective Action" class="form-control mb-2" rows="2"></textarea>
                                
                                <label class="fw-bold">Preventive Action</label>
                                <textarea name="Preventive Action" class="form-control" rows="2"></textarea>
                            </div>
                            <div class="col-md-4 text-center border-start">
                                <label class="fw-bold mb-2">Upload Evidence (Photo)</label>
                                <input type="file" id="evidenceInput" class="form-control" accept="image/*" onchange="handleEvidence()">
                                <small class="text-muted d-block mt-1">Shows in Preview & PPT only.</small>
                                <img id="evidencePreviewImg" alt="Evidence">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="d-flex justify-content-end gap-3 mt-4">
                    <button type="button" class="btn btn-outline-dark px-4" onclick="previewData()"><i class="bi bi-eye"></i> Preview</button>
                    <button type="submit" class="btn btn-primary px-4" id="submitBtn"><i class="bi bi-cloud-upload"></i> Save Data</button>
                </div>
            </form>
        </div>

        <!-- === TAB 2: DASHBOARD === -->
        <div class="tab-pane fade" id="pills-profile">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="text-dark">Saved Inspections</h4>
                <button class="btn btn-sm btn-outline-primary" onclick="loadDashboard()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
            </div>
            <div class="table-responsive bg-white rounded shadow-sm p-3">
                <table class="table table-hover table-custom" id="dashTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Model</th>
                            <th>Line</th>
                            <th>Defect</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="dashBody">
                        <tr><td colspan="5" class="text-center p-4">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Report Preview</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light" id="previewBody">
                <!-- Injected via JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="downloadPPT()"><i class="bi bi-file-ppt"></i> Download PPT</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    // === CONFIGURATION ===
    // PASTE YOUR NEW GOOGLE SCRIPT URL HERE
    const scriptURL = 'https://script.google.com/macros/s/AKfycbx7xNZ5JeWU6QN9IM8WzyTNycDDYWXv3Ej_XJVkIhURkzGxFYH6uCju4_hiWq5gE2ZC/exec'; 

    let logoBase64 = null;
    let evidenceBase64 = null;

    // 1. Auto Load Logo
    window.onload = function() {
        fetch('logo.png')
            .then(r => r.blob())
            .then(b => {
                const reader = new FileReader();
                reader.onloadend = () => { logoBase64 = reader.result; };
                reader.readAsDataURL(b);
            })
            .catch(e => console.log("Logo file not found in repo"));
    };

    // 2. Handle Evidence Image
    function handleEvidence() {
        const file = document.getElementById('evidenceInput').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                evidenceBase64 = e.target.result;
                const img = document.getElementById('evidencePreviewImg');
                img.src = evidenceBase64;
                img.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }

    // 3. Calculation Logic
    function calc() {
        const f = Number(document.getElementById('fQty').value);
        const a = Number(document.getElementById('aQty').value);
        const p = Number(document.getElementById('pQty').value);
        const s = Number(document.getElementById('sampleQty').value);

        const total = f + a + p;
        document.getElementById('totalDefect').value = total;
        document.getElementById('srrRate').value = s > 0 ? ((total/s)*100).toFixed(2) + '%' : '0%';

        // Problem Description
        let desc = "No Major Issues";
        if(f > 0) desc = `Function: ${document.getElementById('fDet').value} (${f} pcs)`;
        else if(a > 0) desc = `Aesthetic: ${document.getElementById('aDet').value} (${a} pcs)`;
        else if(p > 0) desc = `Packing: ${document.getElementById('pDet').value} (${p} pcs)`;
        document.getElementById('problemDesc').value = desc;
    }

    // 4. Save Data
    const form = document.getElementById('pdiForm');
    form.addEventListener('submit', e => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.innerHTML = 'Saving...'; btn.disabled = true;

        fetch(scriptURL, { method: 'POST', body: new FormData(form)})
        .then(res => res.json())
        .then(data => {
            if(data.result === 'success') {
                alert("Saved Successfully!");
                form.reset();
                document.getElementById('evidencePreviewImg').style.display='none';
                evidenceBase64 = null;
            } else {
                alert("Error: " + JSON.stringify(data));
            }
            btn.innerHTML = '<i class="bi bi-cloud-upload"></i> Save Data'; btn.disabled = false;
        })
        .catch(err => {
            alert("Connection Error. Check Script URL.");
            btn.disabled = false;
        });
    });

    // 5. Dashboard Logic (Load & Delete)
    function loadDashboard() {
        const tbody = document.getElementById('dashBody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Fetching Data...</td></tr>';

        fetch(scriptURL)
        .then(res => res.json())
        .then(data => {
            if(data.result === 'success') {
                let rows = '';
                // data.data is an array of arrays
                // Index 0=RowIndex, 1=Date, 2=Model, 3=Color, 4=Line, ...
                data.data.forEach(row => {
                    // Create Date formatted
                    let d = new Date(row[1]).toLocaleDateString();
                    rows += `
                        <tr>
                            <td>${d}</td>
                            <td>${row[2]}</td>
                            <td>${row[4]}</td>
                            <td>${row[24] || 'None'}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteRow(${row[0]})">Delete</button>
                                <button class="btn btn-sm btn-success" onclick="downloadRowPPT('${encodeURIComponent(JSON.stringify(row))}')">PPT</button>
                            </td>
                        </tr>
                    `;
                });
                tbody.innerHTML = rows;
            }
        });
    }

    function deleteRow(rowIndex) {
        if(!confirm("Delete this record?")) return;
        const formData = new FormData();
        formData.append('action', 'delete');
        formData.append('rowIndex', rowIndex);

        fetch(scriptURL, { method: 'POST', body: formData })
        .then(res => res.json())
        .then(() => loadDashboard());
    }

    // 6. Preview Modal
    function previewData() {
        const fd = new FormData(form);
        
        let html = `
            <div class="container-fluid p-3 border rounded bg-white">
                <div class="row mb-3 border-bottom pb-2">
                    <div class="col-2"><img src="${logoBase64 || ''}" style="height:50px"></div>
                    <div class="col-8 text-center"><h3>${fd.get('Model')} - PDI Report</h3></div>
                    <div class="col-2 text-end fw-bold">${fd.get('Date')}</div>
                </div>
                
                <div class="row mb-3 text-center">
                    <div class="col-3 border p-2 bg-light"><strong>Lot:</strong> ${fd.get('Lot Qty')}</div>
                    <div class="col-3 border p-2 bg-light"><strong>Sample:</strong> ${fd.get('Sample Qty')}</div>
                    <div class="col-3 border p-2 bg-light text-danger"><strong>Defects:</strong> ${fd.get('Total Defect Qty')}</div>
                    <div class="col-3 border p-2 bg-light text-primary"><strong>SRR:</strong> ${fd.get('SRR %')}</div>
                </div>

                <div class="row mb-3">
                    <div class="col-6">
                        <h5>Defect Details</h5>
                        <ul>
                            <li>Func: ${fd.get('Func Defect Details')} (${fd.get('Func Qty')})</li>
                            <li>Aes: ${fd.get('Aes Defect Details')} (${fd.get('Aes Qty')})</li>
                            <li>Pack: ${fd.get('Pack Defect Details')} (${fd.get('Pack Qty')})</li>
                        </ul>
                    </div>
                    <div class="col-6">
                        <h5>Action Plan</h5>
                        <p><strong>Problem:</strong> ${fd.get('Problem Desc')}</p>
                        <p><strong>Action:</strong> ${fd.get('Corrective Action')}</p>
                    </div>
                </div>

                ${evidenceBase64 ? `<div class="text-center mt-3"><h5 class="text-danger">Evidence</h5><img src="${evidenceBase64}" style="max-height:200px; border:1px solid #ddd;"></div>` : ''}
            </div>
        `;
        document.getElementById('previewBody').innerHTML = html;
        new bootstrap.Modal(document.getElementById('previewModal')).show();
    }

    // 7. Generate Professional PPT (Light Theme)
    function downloadPPT() {
        createPPT(new FormData(form), evidenceBase64);
    }

    // Helper for Dashboard PPT Download
    function downloadRowPPT(rowString) {
        const row = JSON.parse(decodeURIComponent(rowString));
        // Manually map row array to FormData-like object for the PPT function
        const mockData = {
            get: (key) => {
                const map = {
                    'Date': row[1], 'Model': row[2], 'Line No': row[4],
                    'Lot Qty': row[5], 'Sample Qty': row[6], 'Total Defect Qty': row[7], 'SRR %': row[8],
                    'Func Defect Details': row[9], 'Func Qty': row[10],
                    'Aes Defect Details': row[11], 'Aes Qty': row[12],
                    'Pack Defect Details': row[13], 'Pack Qty': row[14],
                    'Master Carton Date': row[15], 'LQC Date': row[16], 'LQC Name': row[17],
                    'FT Date': row[18], 'FT Name': row[19],
                    'BT Attempt': row[21], 'RF Attempt': row[22],
                    'Team Formation': row[23], 'Problem Desc': row[24],
                    'Root Cause': row[25], 'Corrective Action': row[26], 'Preventive Action': row[27]
                };
                return map[key] || '';
            }
        };
        createPPT(mockData, null); // Evidence logic for dashboard rows is complex, skipping for now
    }

    function createPPT(fd, imgData) {
        let pres = new PptxGenJS();
        
        // Define Light Theme Master
        pres.defineSlideMaster({
            title: "LIGHT_THEME",
            background: { color: "FFFFFF" },
            objects: [
                { rect: { x: 0, y: 0, w: "100%", h: 0.6, fill: "E3F2FD" } }, // Light Blue Header
                { text: { text: "PDI REPORT", options: { x: 0.2, y: 0.1, color: "1565C0", fontSize: 18, bold: true } } }, // Dark Blue Text
                { line: { x: 0, y: 0.6, w: "100%", h: 0, line: "1565C0", lineSize: 2 } },
                { image: { data: logoBase64 || '', x: 9.0, y: 0.05, w: 0.8, h: 0.5 } }
            ]
        });

        let slide = pres.addSlide({ masterName: "LIGHT_THEME" });

        // Title Info
        slide.addText(`Model: ${fd.get('Model')}  |  Date: ${fd.get('Date')}  |  Line: ${fd.get('Line No')}`, 
            { x: 0.2, y: 0.8, fontSize: 14, color: "555555", bold: true });

        // 1. Metrics Grid (Light Colors)
        let metrics = [
            [
                { text: "Lot Qty", options: { fill: "F1F8E9", color: "2E7D32", bold:true } }, // Light Green
                { text: "Sample", options: { fill: "FFF3E0", color: "EF6C00", bold:true } }, // Light Orange
                { text: "Defects", options: { fill: "FFEBEE", color: "C62828", bold:true } }, // Light Red
                { text: "SRR %", options: { fill: "E3F2FD", color: "1565C0", bold:true } }  // Light Blue
            ],
            [ fd.get('Lot Qty'), fd.get('Sample Qty'), fd.get('Total Defect Qty'), fd.get('SRR %') ]
        ];
        slide.addTable(metrics, { x: 0.2, y: 1.2, w: 9.6, h: 0.8, align: "center", fontSize: 12, border:{pt:0} });

        // 2. Defect & Process Info
        slide.addText("Defect Analysis & Traceability", { x: 0.2, y: 2.2, fontSize: 12, color: "1565C0", bold: true });
        
        let details = [
            [{ text: "Defect Details", bold:true, fill:"F5F5F5" }, { text: `F: ${fd.get('Func Defect Details')} (${fd.get('Func Qty')}) | A: ${fd.get('Aes Defect Details')} (${fd.get('Aes Qty')})` }],
            [{ text: "Process Info", bold:true, fill:"F5F5F5" }, { text: `MC Date: ${fd.get('Master Carton Date')} | LQC: ${fd.get('LQC Name')} | FT: ${fd.get('FT Name')}` }]
        ];
        slide.addTable(details, { x: 0.2, y: 2.4, w: 9.6, colW: [2, 7.6], fontSize: 10, border: { color: "DDDDDD" } });

        // 3. Action Plan
        slide.addText("Action Plan", { x: 0.2, y: 3.5, fontSize: 12, color: "1565C0", bold: true });
        let actionRows = [
            [{ text: "Problem", bold:true }, { text: fd.get('Problem Desc') }],
            [{ text: "Root Cause", bold:true }, { text: fd.get('Root Cause') }],
            [{ text: "Corrective Action", bold:true }, { text: fd.get('Corrective Action') }]
        ];
        slide.addTable(actionRows, { x: 0.2, y: 3.7, w: 6.0, colW: [1.5, 4.5], fontSize: 10, border: { color: "DDDDDD" } });

        // 4. Evidence Image Placement (Right Side)
        if (imgData) {
            slide.addText("Evidence", { x: 6.5, y: 3.5, fontSize: 12, color: "C62828", bold: true });
            slide.addImage({ data: imgData, x: 6.5, y: 3.7, w: 3.0, h: 1.8 });
        }

        pres.writeFile({ fileName: `PDI_${fd.get('Model')}.pptx` });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
